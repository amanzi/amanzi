name: Amanzi CI

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - amanzi-*

jobs:
  buildx_test:
    runs-on: ubuntu-latest
    name: Build and test with Docker
    steps:
    - name: Check out the Amanzi repo
      uses: actions/checkout@v3
    - name: Extract the branch name
      id: branch
      run:
        echo "::set-output name=AMANZI_BRANCH::$(echo $GITHUB_REF | sed -e 's/refs\/heads\///')"
    - name: Filter the branch name to generate a tag for Docker
      id: tag
      run:
        echo "::set-output name=AMANZI_BRANCH_TAG::$(echo ${{steps.branch.outputs.AMANZI_BRANCH}} | sed -e 's/\//-/g' | sed -e 's/+/x/g')"
    - name: Output the branch name
      run:
        echo "Amanzi Branch = ${{steps.branch.outputs.AMANZI_BRANCH}}"
    - name: Get TPLs version
      id: version 
      working-directory: Docker
      run:
        echo "::set-output name=AMANZI_TPLS_VER::$(./get_tpls_version.sh)"
    - name: Output the TPLs version
      run:
        echo "TPLs version = ${{steps.version.outputs.AMANZI_TPLS_VER}}"
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    - name: Set up docker buildx
      uses: docker/setup-buildx-action@v2
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{secrets.DOCKERHUB_USERNAME}}
        password: ${{secrets.DOCKERHUB_PASSWORD}}
    - name: Build and push multiarch image
      uses: docker/build-push-action@v4
      with:
        tags: metsi/amanzi:${{steps.tag.outputs.AMANZI_BRANCH_TAG}}-latest
        platforms: linux/amd64,linux/arm64
        push: true
        build-args: |
          amanzi_branch=${{steps.branch.outputs.AMANZI_BRANCH}}
          amanzi_tpls_ver=${{steps.version.outputs.AMANZI_TPLS_VER}}
        file: Docker/Dockerfile-Amanzi-build
        context: ./Docker
    - name: Run tests
      id: tests
      working-directory: Docker
      run:
        docker run --rm ${{secrets.DOCKERHUB_USERNAME}}/amanzi:${{steps.tag.outputs.AMANZI_BRANCH_TAG}}-latest /bin/bash -c "cd ~/amanzi_builddir/amanzi; ctest"
